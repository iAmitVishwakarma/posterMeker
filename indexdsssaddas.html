<!DOCTYPE html>
<html lang="hi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>पोस्टर मेकर</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Cropper.js -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"
    />

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Yatra+One&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Yatra One", system-ui;
      }
      .poster-container {
        width: full;
        position: relative;
        background-image: url("/1000867760.jpg");
        background-size: contain;
        aspect-ratio: 4/5;
        /* transform: translate(); */
      }

      #cropper-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }
    </style>
  </head>

  <body class="bg-gray-100 text-gray-900">
    <div
      class="min-h-screen flex flex-col md:items-center md:justify-center p-4"
    >
      <header
        class="w-full max-w-2xl flex justify-between items-center py-4 px-2"
      >
        <h1 class="text-2xl font-bold">पोस्टर मेकर</h1>
        <button
          id="theme-toggle"
          class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"
        >
          <i class="ph-bold ph-moon text-xl dark:ph-sun"></i>
        </button>
      </header>

      <div
        class="card bg-white p-6 rounded-3xl shadow-xl w-full max-w-2xl flex flex-col md:flex-row gap-6 mb-8"
      >
        <!-- Poster Preview -->
        <div
          class="posterPreviewContainer relative flex-shrink-0 w-full md:w-1/2 bg-gray-900 p-1 rounded"
        >
          <div class="poster-preview-wrapper aspect-[4/5]">
            <div id="poster-container" class="poster-container">
              <img src="/1000867760.jpg" alt="" />
              <!-- User photo area -->
              <div class="absolute bottom-0 right-2 flex w-[85px] aspect-[3/4]">
                <img
                  id="user-photo"
                  alt="User Photo"
                  class="absolute inset-0 w-full h-full object-cover hidden"
                />
                <h6
                  id="user-name"
                  class="bg-red-900 absolute hidden flex justify-center items-start bottom-0 -right-1 w-[110%] text-center rounded-full text-xs text-red-900"
                >
                  <span>- </span>
                </h6>
              </div>
              <!-- User name -->
            </div>
          </div>
        </div>

        <!-- Controls -->
        <div class="md:w-1/2 w-full flex flex-col gap-4 p-4">
          <form id="upload-form" class="space-y-4">
            <h2 class="text-lg font-semibold text-center mb-2">Controls</h2>

            <div>
              <label for="photo-title" class="block mb-1 text-sm font-medium"
                >नाम (सिर्फ हिंदी में)</label
              >
              <input
                type="text"
                id="photo-title"
                placeholder="अपना नाम लिखें"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div>
              <label for="photo-upload" class="block mb-1 text-sm font-medium"
                >फोटो अपलोड करें</label
              >
              <input
                type="file"
                id="photo-upload"
                accept="image/jpeg, image/png"
                class="w-full text-sm file:mr-4 file:px-4 file:py-2 file:rounded-xl file:text-white file:bg-blue-500 hover:file:bg-blue-600 file:cursor-pointer"
              />
            </div>

            <button
              type="submit"
              class="w-full flex justify-center px-4 py-3 bg-blue-500 text-white rounded-xl shadow-md hover:bg-blue-600"
            >
              <i class="ph ph-upload-simple text-xl mr-2"></i> सबमिट
            </button>
          </form>

          <div id="action-buttons" class="grid grid-cols-2 gap-4 mt-4 hidden">
            <button
              id="crop-button"
              class="flex justify-center items-center px-4 py-3 bg-gray-200 rounded-xl hover:bg-gray-300"
            >
              <i class="ph ph-crop text-xl mr-2"></i> क्रॉप
            </button>
            <button
              id="preview-button"
              class="flex justify-center items-center px-4 py-3 bg-gray-200 rounded-xl hover:bg-gray-300"
            >
              <i class="ph ph-eye text-xl mr-2"></i> प्रीव्यू
            </button>
          </div>

          <div id="download-area" class="mt-auto hidden">
            <button
              id="download-button"
              class="w-full flex justify-center items-center px-4 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600"
            >
              <i class="ph ph-download-simple text-xl mr-2"></i> पोस्टर डाउनलोड
              करें
            </button>
          </div>
        </div>
        <div
          id="loading-modal-overlay"
          class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300"
        >
          <div
            class="bg-white p-8 rounded-xl shadow-xl flex flex-col items-center gap-4 dark:bg-gray-800 dark:text-white"
          >
            <div
              class="animate-spin h-8 w-8 rounded-full border-4 border-white border-t-blue-500"
            ></div>
            <p id="loader-text">Cropping image...</p>
          </div>
        </div>
      </div>

      <!-- Cropper Modal -->
      <div id="cropper-modal-overlay">
        <div
          class="bg-gray-800 p-6 rounded-xl w-[90%] max-w-lg flex flex-col gap-4"
        >
          <h2 class="text-white text-xl font-bold">क्रॉप और एडजस्ट (4:3)</h2>
          <div
            class="flex-grow overflow-hidden flex items-center justify-center"
          >
            <img id="image-to-crop" class="max-h-full w-full object-contain" />
          </div>
          <div class="flex gap-4">
            <button
              id="cancel-crop"
              class="w-1/2 flex justify-center items-center px-4 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600"
            >
              <i class="ph ph-x-circle text-xl mr-2"></i> कैंसिल
            </button>
            <button
              id="confirm-crop"
              class="w-1/2 flex justify-center items-center px-4 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600"
            >
              <i class="ph ph-check-circle text-xl mr-2"></i> कन्फर्म
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const uploadForm = document.getElementById("upload-form");
        const posterContainer = document.getElementById("poster-container");
        const userPhoto = document.getElementById("user-photo");
        const userName = document.getElementById("user-name");
        const loadingModal = document.getElementById("loading-modal-overlay");
        const loaderText = document.getElementById("loader-text");
        const cropperModal = document.getElementById("cropper-modal-overlay");
        const imageToCrop = document.getElementById("image-to-crop");
        const cropButton = document.getElementById("crop-button");
        const confirmCrop = document.getElementById("confirm-crop");
        const cancelCrop = document.getElementById("cancel-crop");
        const downloadButton = document.getElementById("download-button");
        const actionButtons = document.getElementById("action-buttons");
        const downloadArea = document.getElementById("download-area");
        const previewButton = document.getElementById("preview-button");
        overlayTxet = "";
        let cropper,
          currentBlob,
          isPreview = false;

        uploadForm.reset();

        function isHindi(text) {
          return /^[\u0900-\u097F\s]+$/.test(text);
        }

        function showLoader(message) {
          loaderText.textContent = message;
          loadingModal.classList.remove("hidden");
          loadingModal.classList.add("flex");
        }

        function hideLoader() {
          loadingModal.classList.remove("flex");
          loadingModal.classList.add("hidden");
        }

        uploadForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = e.target[0].value;
          const file = e.target[1].files[0];

          if (!file) return alert("कृपया फोटो चुनें।");
          if (!isHindi(name.trim())) return alert("नाम सिर्फ हिंदी में लिखें।");
          overlayTxet = name;
          const url = URL.createObjectURL(file);
          imageToCrop.src = url;
          cropperModal.style.display = "flex";
          uploadForm.reset();
        });

        // confirmCrop.addEventListener("click", () => {
        //   const canvas = cropper.getCroppedCanvas({ width: 300, height: 400 });
        //   cropperModal.style.display = "none";
        //   canvas.toBlob(async (blob) => {
        //     if (!blob) {
        //       alert("Error: Could not crop the image.");
        //       return;
        //     }
        //     uploadForm.classList.add("hidden");
        //     showLoader("Removing background...");

        //     try {
        //       // Send cropped image to Photoroom background removal API
        //       const formData = new FormData();
        //       formData.append("imageFile", blob, "cropped_image.png");
        //       formData.append("shadow.mode", "ai.soft");
        //       formData.append("background.color", "FFFFFF");
        //       formData.append("padding", "0.1");

        //       const response = await fetch(
        //         "https://image-api.photoroom.com/v2/edit",
        //         {
        //           method: "POST",
        //           headers: {
        //             Accept: "image/png, application/json",
        //             "X-Api-Key":
        //               "sandbox_sk_pr_default_9e7fd02ee0ba314ab90e7966b660ad9b34f88e71",
        //           },
        //           body: formData,
        //         }
        //       );

        //       if (!response.ok) {
        //         throw new Error(
        //           "Background removal failed. Check API key or image format."
        //         );
        //       }

        //       const resultBlob = await response.blob();
        //       currentBlob = resultBlob;
        //       userPhoto.src = URL.createObjectURL(resultBlob);
        //       userPhoto.classList.remove("hidden");

        //       cropper.destroy();
        //       cropperModal.style.display = "none";
        //       actionButtons.classList.remove("hidden");
        //       downloadArea.classList.remove("hidden");
        //     } catch (error) {
        //       console.error("Background removal error:", error);
        //       alert("Error: Could not remove the background.");
        //     } finally {
        //       hideLoader();
        //     }
        //   }, "image/jpeg");
        // });


// async function processCroppedImage(cropper, apiKey) {
//   if (!cropper) return;

//   const croppedCanvas = cropper.getCroppedCanvas({ width: 800, height: 600 });

//   hideCropperModal();
//   showLoader("Editing image...");

//   return new Promise((resolve, reject) => {
//     croppedCanvas.toBlob(async (blob) => {
//       if (!blob) {
//         hideLoader();
//         alert("Error: Could not crop the image.");
//         return reject("Blob creation failed");
//       }

//       try {
//         const formData = new FormData();
//         formData.append("image_file", blob, "cropped_image.png");

//         const response = await fetch("https://sdk.photoroom.com/v1/segment", {
//           method: "POST",
//           headers: {
//             "X-Api-Key": apiKey,
//             Accept: "image/png, application/json",
//           },
//           body: formData,
//         });

//         if (!response.ok) {
//           console.error(await response.json());
//           alert("Background removal failed.");
//           return reject("API error");
//         }

//         const resultBlob = await response.blob();
//         const objectURL = URL.createObjectURL(resultBlob);

//         userPhoto.src = objectURL;
//         userPhoto.classList.remove("hidden");
//         uploadPlaceholder.classList.add("hidden");
//         downloadArea.classList.remove("hidden");

//         resolve(resultBlob);
//       } catch (error) {
//         console.error("Image edit error:", error);
//         alert("Something went wrong. Try again.");
//         reject(error);
//       } finally {
//         hideLoader();
//       }
//     }, "image/png");
//   });
// }

// confirmCrop.addEventListener("click", async () => {
//   Form.classList.add("hidden");

//   try {
//     await processCroppedImage(cropper, "sk_pr_default_9e7fd02ee0ba314ab90e7966b660ad9b34f88e71");
//   } catch (err) {
//     console.warn("Processing failed:", err);
//   }
// });



// Configuration
const REMOVAL_AI_API_URL = "https://api.removal.ai/3.0/remove";
const REMOVAL_AI_TOKEN = "011a1a91-75c7-404a-8633-e883d929b4f9"; 


// Utility to convert canvas to image blob
async function canvasToBlob(canvas, type = "image/png", quality = 0.95) {
  return new Promise((resolve, reject) => {
    canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error("Blob conversion failed")), type, quality);
  });
}

// Prepare image for upload for Clipdrop API
function buildFormData(imageBlob) {
  const formData = new FormData();
  formData.append("image_file", imageBlob, "cropped_image.png");
  return formData;
}

// Core background removal process using Clipdrop
async function removeBackgroundWithRemovalAI(fileInput) {
  if (!fileInput) throw new Error("Cropper instance missing");

  const canvas = fileInput.getCroppedCanvas({
    width: 800,
    height: 600,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: 'high'
  });

  if (!canvas) throw new Error("Unable to generate canvas");

  cropperModal.style.display = "none";

  showLoader("Removing background with Removal.ai...");

  try {
    const imageBlob = await canvasToBlob(canvas);

   const response = await fetch(REMOVAL_AI_API_URL, {
      method: "POST",
      headers: {
        "Rm-Token": REMOVAL_AI_TOKEN
      },
      body: buildFormData(imageBlob),
      signal: AbortSignal.timeout(30000)
    });


    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.message || "Clipdrop API failed");
    }

    const resultBlob = await response.blob();
    const imageURL = URL.createObjectURL(resultBlob);

    userPhoto.src = imageURL;
    userPhoto.classList.remove("hidden");
    uploadPlaceholder.classList.add("hidden");
    downloadArea.classList.remove("hidden");

    return resultBlob;
  } 
  finally {
    hideLoader();
  }
}



// Crop confirm event with enhanced error handling
confirmCrop.addEventListener("click", async () => {
  uploadForm.classList.add("hidden");
  showLoader("Removing background...");

   try {
    await removeBackgroundWithRemovalAI(cropper);
    // showSuccessToast("Background removed!");
  } catch (error) {
    console.error("Error:", error);
    // showErrorToast("Failed to remove background");
  }
 finally {
    hideLoader();
  }
});








        cancelCrop.addEventListener("click", () => {
          cropper.destroy();
          cropperModal.style.display = "none";
        });

        cropButton.addEventListener("click", () => {
          imageToCrop.src = URL.createObjectURL(currentBlob);
          cropperModal.style.display = "flex";
        });

        imageToCrop.onload = () => {
          if (cropper) cropper.destroy();
          cropper = new Cropper(imageToCrop, {
            aspectRatio: 3 / 4,
            viewMode: 1,
            dragMode: "move",
          });
        };

        previewButton.addEventListener("click", () => {
          isPreview = true;
          alert(
            "प्रीव्यू नीचे देखें (इसे स्केल किया गया है, असली डाउनलोड हाई-क्वालिटी में होगा)।"
          );
        });

        downloadButton.addEventListener("click", () => {
          if (!userPhoto.src || userPhoto.classList.contains("hidden")) {
            alert("कृपया पहले फोटो अपलोड करें!");
            return;
          }

          // 🔤 Add custom text dynamically to poster preview
          const posterPreviewWrapper = document.querySelector(
            ".posterPreviewContainer"
          );
          userName.classList.remove("hidden");
          // Check if text already added
          let existingText = document.querySelector(".customPosterText");
          if (!existingText) {
            const posterText = document.createElement("div");
            posterText.className = "customPosterText";
            posterText.innerText = overlayTxet;
            posterText.style.position = "absolute";
            posterText.style.bottom = "9px";
            posterText.style.transform = "translate(-1px , -1px)";
            posterText.style.right = "5px";
            posterText.style.width = "30%";
            posterText.style.textAlign = "center";
            posterText.style.fontSize = "8px";
            posterText.style.fontWeight = "bold";
            posterText.style.color = "#FFF";
            posterText.style.zIndex = "10";

            // Append to preview container
            posterPreviewWrapper.appendChild(posterText);
          }

          html2canvas(posterPreviewWrapper, {
            scale: window.devicePixelRatio * 2,
          }).then((canvas) => {
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png", 1.0);
            link.download = "my-poster.png";
            link.click();
          });
        });
      });
    </script>
  </body>
</html>
